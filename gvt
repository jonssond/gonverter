#!/bin/bash

# Gonverter Docker Wrapper Script
# This script runs the gonverter application in a Docker container

IMAGE_NAME="gonverter:latest"
CONFIG_FILE="$HOME/.gonverter-config"

# Check if Docker is installed
if ! command -v docker &> /dev/null; then
    echo "Error: Docker is not installed. Please install Docker first."
    exit 1
fi

# Check if the Docker image exists, if not, build it
if ! docker image inspect $IMAGE_NAME &> /dev/null; then
    echo "Docker image not found. Building..."
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    
    if [ ! -f "$SCRIPT_DIR/Dockerfile" ]; then
        echo "Error: Dockerfile not found in $SCRIPT_DIR"
        exit 1
    fi
    
    docker build -t $IMAGE_NAME "$SCRIPT_DIR"
    if [ $? -ne 0 ]; then
        echo "Error: Failed to build Docker image"
        exit 1
    fi
fi

# Parse arguments to find output directory
OUTPUT_DIR=""
NEXT_IS_OUTPUT=false
for arg in "$@"; do
    if [[ "$arg" == "-output" ]]; then
        NEXT_IS_OUTPUT=true
    elif [[ "$NEXT_IS_OUTPUT" == true ]]; then
        OUTPUT_DIR="$arg"
        break
    fi
done

# If no output specified in args, check saved config
if [ -z "$OUTPUT_DIR" ] && [ -f "$CONFIG_FILE" ]; then
    OUTPUT_DIR=$(cat "$CONFIG_FILE" 2>/dev/null | tr -d '\n\r' | xargs)
fi

# Build volume mount arguments array
VOLUME_ARGS=()

# Always mount HOME directory
VOLUME_ARGS+=("-v" "$HOME:$HOME")

# Mount the output directory if it exists and is not within HOME
if [ -n "$OUTPUT_DIR" ]; then
    # Convert to absolute path
    if [[ "$OUTPUT_DIR" != /* ]]; then
        OUTPUT_DIR="$(pwd)/$OUTPUT_DIR"
    fi
    OUTPUT_DIR=$(realpath -m "$OUTPUT_DIR" 2>/dev/null || echo "$OUTPUT_DIR")
    
    # Create the directory if it doesn't exist
    mkdir -p "$OUTPUT_DIR" 2>/dev/null
    
    # Mount if not already covered by HOME mount
    if [[ "$OUTPUT_DIR" != "$HOME"* ]]; then
        VOLUME_ARGS+=("-v" "$OUTPUT_DIR:$OUTPUT_DIR")
    fi
fi

# Mount current directory if not within HOME or OUTPUT_DIR
CURRENT_DIR="$(pwd)"
MOUNT_CURRENT=true

if [[ "$CURRENT_DIR" == "$HOME"* ]]; then
    MOUNT_CURRENT=false
fi

if [ -n "$OUTPUT_DIR" ] && [[ "$CURRENT_DIR" == "$OUTPUT_DIR"* ]]; then
    MOUNT_CURRENT=false
fi

if [ "$MOUNT_CURRENT" = true ]; then
    VOLUME_ARGS+=("-v" "$CURRENT_DIR:$CURRENT_DIR")
fi

# Run the container with proper volume mounts
docker run --rm \
    "${VOLUME_ARGS[@]}" \
    -w "$CURRENT_DIR" \
    -e HOME="$HOME" \
    "$IMAGE_NAME" \
    "$@"